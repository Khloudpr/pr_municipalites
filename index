<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguadilla Reporta - Municipio Aut√≥nomo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; scroll-behavior: smooth; }
        .hero-bg {
            background: linear-gradient(rgba(15, 23, 42, 0.5), rgba(15, 23, 42, 0.5)), 
                        url('https://images.unsplash.com/photo-1590508734141-694611b1e562?q=80&w=2070&auto=format&fit=crop');
            background-size: cover; background-position: center;
        }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); }
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .report-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .report-card:hover { transform: translateY(-3px); }
        .hidden-tab { display: none; }
        .active-btn { background-color: #1e3a8a !important; color: white !important; }
        
        /* Toast Notification Styles */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { 
            background: white; 
            padding: 16px 20px; 
            border-radius: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.warning { border-left: 4px solid #f59e0b; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        .toast.hiding { animation: slideOut 0.3s ease-in; }
        
        /* Loading Spinner */
        .spinner { 
            border: 3px solid #f3f4f6; 
            border-top: 3px solid #1e3a8a; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 0.8s linear infinite; 
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Input validation states */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ==================== LANDING PAGE ====================-->
    <div id="landing-section">
        <nav class="bg-white/90 backdrop-blur-md py-4 px-6 md:px-12 flex justify-between items-center sticky top-0 z-50 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Escudo_de_Aguadilla.svg/1200px-Escudo_de_Aguadilla.svg.png" alt="Escudo" class="h-10 w-auto">
                <span class="font-extrabold text-xl tracking-tighter text-blue-900 uppercase italic">Aguadilla Reporta</span>
            </div>
            <div class="hidden md:flex gap-8 font-semibold text-slate-600">
                <a href="#como-funciona" class="hover:text-blue-600 transition">¬øC√≥mo funciona?</a>
                <a href="#beneficios" class="hover:text-blue-600 transition">Beneficios</a>
            </div>
            <button onclick="mostrarVista('login-section')" class="bg-blue-600 text-white px-8 py-2.5 rounded-full font-bold hover:bg-blue-700 transition-all shadow-lg">Ingresar</button>
        </nav>

        <header class="hero-bg h-[70vh] flex items-center justify-center text-center text-white px-6">
            <div class="max-w-4xl animate-fade-in">
                <h1 class="text-5xl md:text-7xl font-extrabold mb-6 leading-tight">Tu ciudad, tu voz,<br>tu compromiso.</h1>
                <p class="text-lg md:text-2xl mb-10 text-slate-100 font-light max-w-2xl mx-auto">Reporta situaciones en segundos y ayuda a mantener el Jard√≠n del Atl√°ntico impecable.</p>
                <button onclick="mostrarVista('registro-section')" class="bg-emerald-500 hover:bg-emerald-400 text-white px-10 py-5 rounded-2xl text-xl font-extrabold shadow-2xl transition-all hover:scale-105">Reportar Ahora</button>
            </div>
        </header>

        <section id="como-funciona" class="py-24 px-6 bg-white">
            <div class="max-w-6xl mx-auto text-center">
                <h2 class="text-4xl font-extrabold mb-4 uppercase tracking-tight">¬øC√ìMO FUNCIONA?</h2>
                <div class="h-1 w-20 bg-blue-600 mx-auto mb-20"></div>
                <div class="grid md:grid-cols-3 gap-12">
                    <div class="flex flex-col items-center">
                        <div class="bg-blue-50 text-blue-600 w-24 h-24 rounded-full flex items-center justify-center mb-6 text-4xl shadow-sm"><i class="fas fa-edit"></i></div>
                        <h3 class="text-xl font-extrabold mb-2">1. Reg√≠strate</h3>
                        <p class="text-slate-500 text-sm px-4">Crea tu cuenta con tu informaci√≥n b√°sica de forma segura.</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="bg-blue-50 text-blue-600 w-24 h-24 rounded-full flex items-center justify-center mb-6 text-4xl shadow-sm"><i class="fas fa-camera"></i></div>
                        <h3 class="text-xl font-extrabold mb-2">2. Reporta el problema</h3>
                        <p class="text-slate-500 text-sm px-4">Describe la situaci√≥n y a√±ade fotos para identificarla mejor.</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="bg-blue-50 text-blue-600 w-24 h-24 rounded-full flex items-center justify-center mb-6 text-4xl shadow-sm"><i class="fas fa-chart-line"></i></div>
                        <h3 class="text-xl font-extrabold mb-2">3. Dale seguimiento</h3>
                        <p class="text-slate-500 text-sm px-4">Consulta el estado de tus reportes directamente desde tu cuenta.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="beneficios" class="py-24 px-6 bg-slate-50">
            <div class="max-w-4xl mx-auto glass-card rounded-[2.5rem] p-12 shadow-xl border border-white">
                <h2 class="text-3xl font-extrabold text-center mb-16">¬øPor qu√© usar Aguadilla Reporta?</h2>
                <div class="grid md:grid-cols-2 gap-10">
                    <div class="flex items-center gap-5">
                        <i class="fas fa-map-marker-alt text-emerald-500 text-2xl"></i>
                        <span class="font-bold text-slate-700">No necesitas ir al municipio</span>
                    </div>
                    <div class="flex items-center gap-5">
                        <i class="fas fa-mobile-alt text-emerald-500 text-2xl"></i>
                        <span class="font-bold text-slate-700">Disponible desde celular o PC</span>
                    </div>
                    <div class="flex items-center gap-5">
                        <i class="fas fa-folder-open text-emerald-500 text-2xl"></i>
                        <span class="font-bold text-slate-700">Tus reportes quedan registrados</span>
                    </div>
                    <div class="flex items-center gap-5">
                        <i class="fas fa-comments text-emerald-500 text-2xl"></i>
                        <span class="font-bold text-slate-700">Comunicaci√≥n directa y organizada</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-20 px-6 bg-blue-900 text-white text-center">
            <h2 class="text-3xl font-extrabold mb-4 italic">¬øVes algo que necesita atenci√≥n?</h2>
            <p class="text-slate-300 mb-10">Rep√≥rtalo ahora y s√© parte del cambio.</p>
            <button onclick="mostrarVista('registro-section')" class="bg-emerald-500 hover:bg-emerald-400 px-12 py-4 rounded-2xl text-xl font-bold transition-all shadow-xl">Reportar ahora</button>
        </section>

        <footer class="py-12 bg-slate-950 text-slate-500 text-center border-t border-slate-900">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Escudo_de_Aguadilla.svg/1200px-Escudo_de_Aguadilla.svg.png" alt="Escudo" class="h-12 mx-auto mb-6 opacity-50 grayscale">
            <p class="text-sm">¬© 2026 Municipio de Aguadilla - El Jard√≠n del Atl√°ntico</p>
        </footer>
    </div>

    <!-- ==================== LOGIN SECTION ==================== -->
    <div id="login-section" class="hidden min-h-screen flex items-center justify-center px-6 py-12 hero-bg">
        <div class="max-w-md w-full glass-card rounded-[2.5rem] shadow-2xl p-10 animate-fade-in">
            <div class="text-center mb-10">
                <div class="bg-blue-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg font-black text-xl">AR</div>
                <h2 class="text-2xl font-extrabold">Bienvenido</h2>
                <p class="text-slate-500 text-sm mt-2">Ingresa tus credenciales para acceder</p>
            </div>
            <form class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Correo Electr√≥nico</label>
                    <input type="email" id="login_email" placeholder="correo@ejemplo.com" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Contrase√±a</label>
                    <input type="password" id="login_pass" placeholder="********" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">
                </div>
                <button type="button" onclick="manejarAuth('login')" id="btn-login" class="w-full bg-blue-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-slate-800 transition-all">Entrar</button>
                <div class="text-center pt-4">
                    <button type="button" onclick="resetPassword()" class="block w-full text-slate-400 text-[11px] font-bold uppercase mb-4 hover:text-blue-600 transition">¬øOlvidaste tu contrase√±a?</button>
                    <button type="button" onclick="mostrarVista('registro-section')" class="text-blue-600 font-bold text-sm">¬øEres nuevo? Crea tu cuenta aqu√≠</button>
                    <button type="button" onclick="mostrarVista('landing-section')" class="block w-full text-slate-400 text-xs mt-6 font-semibold uppercase tracking-widest">Volver al inicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== REGISTRO SECTION ==================== -->
    <div id="registro-section" class="hidden min-h-screen flex items-center justify-center px-6 py-12 hero-bg">
        <div class="max-w-md w-full glass-card rounded-[2.5rem] shadow-2xl p-10 animate-fade-in">
            <div class="text-center mb-8">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Escudo_de_Aguadilla.svg/1200px-Escudo_de_Aguadilla.svg.png" alt="Escudo" class="h-14 mx-auto mb-4">
                <h2 class="text-2xl font-extrabold">Registro de Ciudadano</h2>
                <p class="text-slate-500 text-sm mt-2">Completa estos datos para empezar</p>
            </div>
            <form class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="reg_nom" placeholder="Nombre" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-3.5 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">
                    <input type="text" id="reg_ape" placeholder="Apellido" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-3.5 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">
                </div>
                <input type="tel" id="reg_tel" placeholder="Tel√©fono 787-000-0000" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-3.5 text-slate-700 focus:outline-none focus:border-blue-600 transition-all font-mono">
                
                <input type="email" id="reg_email" placeholder="correo@ejemplo.com" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-3.5 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">

                <div class="relative">
                    <input type="password" id="reg_pass" oninput="validarEnTiempoReal()" placeholder="Crea tu contrase√±a" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-3.5 text-slate-700 focus:outline-none focus:border-blue-600 transition-all">
                    <button type="button" onclick="togglePassword('reg_pass')" class="absolute right-4 top-3.5 text-slate-400"><i class="fas fa-eye" id="eye-icon"></i></button>
                </div>

                <div class="bg-slate-100/50 p-4 rounded-2xl text-[11px] space-y-2 border border-slate-100">
                    <p class="font-bold text-slate-500 uppercase tracking-wider mb-1">Tu contrase√±a debe tener:</p>
                    <p id="req-length" class="text-slate-400 flex items-center gap-2"><i class="fas fa-circle text-[6px]"></i> M√≠nimo 8 caracteres</p>
                    <p id="req-upper" class="text-slate-400 flex items-center gap-2"><i class="fas fa-circle text-[6px]"></i> Una May√∫scula (A-Z)</p>
                    <p id="req-lower" class="text-slate-400 flex items-center gap-2"><i class="fas fa-circle text-[6px]"></i> Una Min√∫scula (a-z)</p>
                    <p id="req-number" class="text-slate-400 flex items-center gap-2"><i class="fas fa-circle text-[6px]"></i> Un N√∫mero (0-9)</p>
                </div>

                <button type="button" onclick="manejarAuth('registro')" id="btn-reg" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-600 transition-all">Registrarme y Reportar</button>
                <div class="text-center pt-4">
                    <button type="button" onclick="mostrarVista('login-section')" class="text-slate-400 font-semibold text-xs underline underline-offset-4">Ya tengo cuenta / Ingresar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== PANEL DE REPORTES ==================== -->
    <div id="panel-section" class="hidden min-h-screen bg-f8fafc pb-20">
        <header class="glass-header sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-900 text-white w-10 h-10 rounded-xl flex items-center justify-center font-black">AR</div>
                <div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Bienvenido</p>
                    <h2 id="user-greeting" class="text-sm font-extrabold text-slate-800">Usuario</h2>
                </div>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </header>

        <main class="max-w-xl mx-auto p-6">
            
            <div class="flex gap-2 bg-slate-200/50 p-1.5 rounded-2xl mb-8">
                <button id="btn-nuevo" onclick="cambiarTab('nuevo')" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all active-btn">NUEVO REPORTE</button>
                <button id="btn-historial" onclick="cambiarTab('historial')" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all text-slate-500">MIS REPORTES</button>
            </div>

            <div id="tab-nuevo" class="space-y-6">
                <div class="bg-white rounded-[2rem] p-8 shadow-sm border border-slate-100">
                    <h3 class="text-xl font-black text-blue-900 mb-6 uppercase italic tracking-tighter">Crear Incidencia</h3>
                    
                    <form id="form-reporte" class="space-y-5">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-2 block tracking-widest">¬øQu√© sucede?</label>
                            <select id="categoria" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm font-semibold text-slate-700 outline-none focus:border-blue-600 transition-all appearance-none cursor-pointer">
                                <option value="Alumbrado P√∫blico">Alumbrado P√∫blico</option>
                                <option value="Baches / Hoyos">Baches / Hoyos</option>
                                <option value="Escombros">Escombros / Vertederos</option>
                                <option value="√Åreas Verdes">√Åreas Verdes / Ornato</option>
                                <option value="Otros">Otros</option>
                            </select>
                            <span id="error-categoria" class="text-xs text-red-500 ml-1 mt-1 hidden"></span>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-2 block tracking-widest">Ubicaci√≥n (Referencia)</label>
                            <input type="text" id="ubicacion_texto" placeholder="Ej: Frente a la cancha de Bo. Tamarindo" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-600 transition-all">
                            <span id="error-ubicacion" class="text-xs text-red-500 ml-1 mt-1 hidden"></span>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2 px-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Descripci√≥n</label>
                                <span id="char-count" class="text-[10px] font-bold text-blue-600">0/150</span>
                            </div>
                            <textarea id="descripcion" maxlength="150" rows="3" placeholder="Describe brevemente el problema..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm outline-none focus:border-blue-600 transition-all resize-none"></textarea>
                            <span id="error-descripcion" class="text-xs text-red-500 ml-1 mt-1 hidden"></span>
                        </div>

                        <div class="pt-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-3 block tracking-widest">Evidencia Fotogr√°fica</label>
                            <div id="drop-area" class="border-2 border-dashed border-slate-200 rounded-[2rem] p-8 text-center bg-slate-50/50 hover:bg-slate-50 transition-all cursor-pointer">
                                <input type="file" id="foto" accept="image/*" class="hidden">
                                <div onclick="document.getElementById('foto').click()" id="preview-container">
                                    <i class="fas fa-camera text-3xl text-blue-900/30 mb-3"></i>
                                    <p class="text-xs font-bold text-slate-400">TOMA UNA FOTO O SUBE ARCHIVO</p>
                                    <p class="text-[9px] text-blue-500 mt-2 font-black italic uppercase tracking-tighter" id="gps-status"></p>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" id="lat">
                        <input type="hidden" id="lng">
                        <input type="hidden" id="foto_base64">

                        <button type="button" onclick="enviarReporte()" id="btn-enviar" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-900/20 hover:bg-slate-800 transition-all uppercase tracking-widest mt-4">
                            <span id="btn-text">Enviar al Municipio</span>
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-historial" class="hidden-tab space-y-4">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-[0.2em] mb-6 px-2">Mis Gestiones Recientes</h3>
                <div id="lista-historial" class="space-y-4">
                    <div class="text-center py-20 opacity-20">
                        <i class="fas fa-folder-open text-5xl mb-4"></i>
                        <p class="font-bold text-xs">A√öN NO TIENES REPORTES</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // URL correcta del Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwf6zkn7u0PO3t9TPkVG2NjoDwRF7-BuSAtP4T0PXaDStulKQBJOXqzWFwm5Nqh6LP-jA/exec";
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        let currentUser = null;

        // Debug mode - puedes activarlo temporalmente
        const DEBUG_MODE = true;
        
        function logDebug(msg, data) {
            if(DEBUG_MODE) {
                console.log('üîç DEBUG:', msg, data);
            }
        }

        // ==================== INICIALIZACI√ìN ====================
        window.onload = function() {
            const session = JSON.parse(localStorage.getItem('user_session') || 'null');
            if(session && session.email) {
                currentUser = session;
                mostrarVista('panel-section');
                document.getElementById('user-greeting').innerText = `${session.nombre} ${session.apellido}`;
            }
        };

        // ==================== NAVEGACI√ìN ====================
        function mostrarVista(idVista) {
            document.getElementById('landing-section').classList.add('hidden');
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('registro-section').classList.add('hidden');
            document.getElementById('panel-section').classList.add('hidden');
            document.getElementById(idVista).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function mostrarToast(mensaje, tipo = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            const iconos = {
                success: 'fa-check-circle text-green-500',
                error: 'fa-times-circle text-red-500',
                warning: 'fa-exclamation-circle text-yellow-500'
            };
            
            toast.innerHTML = `
                <i class="fas ${iconos[tipo]} text-xl"></i>
                <div class="flex-1">
                    <p class="text-sm font-bold text-slate-800">${mensaje}</p>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ==================== AUTH FUNCTIONS ====================
        function togglePassword(id) {
            const p = document.getElementById(id);
            const icon = document.getElementById('eye-icon');
            p.type = p.type === "password" ? "text" : "password";
            icon.classList.toggle('fa-eye'); 
            icon.classList.toggle('fa-eye-slash');
        }

        function limpiarCampos() {
            const campos = ['reg_nom', 'reg_ape', 'reg_tel', 'reg_email', 'reg_pass', 'login_email', 'login_pass'];
            campos.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            validarEnTiempoReal();
        }

        function validarEnTiempoReal() {
            const pass = document.getElementById('reg_pass').value;
            const reglas = {
                "req-length": pass.length >= 8,
                "req-upper": /[A-Z]/.test(pass),
                "req-lower": /[a-z]/.test(pass),
                "req-number": /\d/.test(pass)
            };
            let todoOk = true;
            for (const [id, ok] of Object.entries(reglas)) {
                const el = document.getElementById(id);
                if (ok) {
                    el.classList.replace('text-slate-400', 'text-emerald-600');
                    el.classList.add('font-bold');
                    el.querySelector('i').className = "fas fa-check-circle";
                } else {
                    el.classList.replace('text-emerald-600', 'text-slate-400');
                    el.classList.remove('font-bold');
                    el.querySelector('i').className = "fas fa-circle text-[6px]";
                    todoOk = false;
                }
            }
            return todoOk;
        }

        async function resetPassword() {
            const email = prompt("Ingresa tu correo electr√≥nico registrado:");
            if (!email) return;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'solicitarReset', email: email })
                });
                const res = await response.json();
                mostrarToast(res.message, res.result === 'success' ? 'success' : 'error');
            } catch (e) {
                mostrarToast("Si el correo est√° registrado, recibir√°s un mensaje de recuperaci√≥n pronto.", 'warning');
            }
        }

        async function manejarAuth(tipo) {
            const btn = document.getElementById(tipo === 'login' ? 'btn-login' : 'btn-reg');
            const emailInput = document.getElementById(tipo === 'login' ? 'login_email' : 'reg_email');
            const passwordInput = document.getElementById(tipo === 'login' ? 'login_pass' : 'reg_pass');
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            logDebug('Iniciando auth', {tipo, email});

            // Validaci√≥n b√°sica
            if (!email) {
                mostrarToast("Por favor, ingresa tu correo electr√≥nico.", 'warning');
                emailInput.focus();
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                mostrarToast("Por favor, ingresa un correo electr√≥nico v√°lido.", 'warning');
                emailInput.focus();
                return;
            }

            if (!password) {
                mostrarToast("Por favor, ingresa tu contrase√±a.", 'warning');
                passwordInput.focus();
                return;
            }

            const datos = {
                action: tipo === 'login' ? 'login' : 'register',
                email: email.toLowerCase(),
                password: password
            };

            if (tipo === 'registro') {
                // Validar contrase√±a
                if (!validarEnTiempoReal()) {
                    mostrarToast("La contrase√±a no cumple con los requisitos de seguridad.", 'warning');
                    passwordInput.focus();
                    return;
                }

                const nombre = document.getElementById('reg_nom').value.trim();
                const apellido = document.getElementById('reg_ape').value.trim();
                const telefono = document.getElementById('reg_tel').value.trim();

                if (!nombre) {
                    mostrarToast("Por favor, ingresa tu nombre.", 'warning');
                    document.getElementById('reg_nom').focus();
                    return;
                }

                if (!apellido) {
                    mostrarToast("Por favor, ingresa tu apellido.", 'warning');
                    document.getElementById('reg_ape').focus();
                    return;
                }

                if (!telefono) {
                    mostrarToast("Por favor, ingresa tu tel√©fono.", 'warning');
                    document.getElementById('reg_tel').focus();
                    return;
                }

                // Validar formato de tel√©fono b√°sico
                if (telefono.length < 10) {
                    mostrarToast("El tel√©fono debe tener al menos 10 d√≠gitos.", 'warning');
                    document.getElementById('reg_tel').focus();
                    return;
                }

                datos.nombre = nombre;
                datos.apellido = apellido;
                datos.telefono = telefono;

                logDebug('Datos de registro', datos);
            }

            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                logDebug('Enviando petici√≥n a', SCRIPT_URL);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(datos)
                });

                logDebug('Respuesta recibida', {status: response.status});

                const res = await response.json();
                
                logDebug('Datos de respuesta', res);

                if (res.result === "success") {
                    if (tipo === 'registro') {
                        mostrarToast("¬°Cuenta creada exitosamente!", 'success');
                        limpiarCampos();
                        setTimeout(() => mostrarVista('login-section'), 1500);
                    } else {
                        // Login exitoso - VERIFICAR ROL
                        const sessionData = {
                            nombre: res.nombre,
                            apellido: res.apellido,
                            email: res.email,
                            telefono: res.telefono,
                            rol: res.rol || 'user',
                            departamento: res.departamento || 'Ciudadano'
                        };
                        
                        localStorage.setItem('user_session', JSON.stringify(sessionData));
                        currentUser = sessionData;
                        
                        mostrarToast(`¬°Bienvenido ${res.nombre}!`, 'success');
                        
                        // REDIRIGIR SEG√öN ROL
                        setTimeout(() => {
                            if (sessionData.rol === 'empleado' || sessionData.rol === 'admin') {
                                // Redirigir a dashboard de empleados
                                window.location.href = 'dashboard1.html';
                            } else {
                                // Redirigir a panel de ciudadano
                                mostrarVista('panel-section');
                                document.getElementById('user-greeting').innerText = `${res.nombre} ${res.apellido}`;
                            }
                        }, 1000);
                    }
                } else if (res.result === "exists") {
                    mostrarToast(res.message || "Este correo ya est√° registrado.", 'warning');
                } else if (res.result === "error") {
                    mostrarToast(res.message || "Error en la operaci√≥n.", 'error');
                } else {
                    mostrarToast("Credenciales incorrectas. Verifica tus datos.", 'error');
                }

            } catch (error) {
                logDebug('Error en petici√≥n', error);
                console.error('Error completo:', error);
                
                mostrarToast("Error de conexi√≥n. Por favor verifica tu conexi√≥n a internet e intenta nuevamente.", 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==================== PANEL DE REPORTES ====================
        
        // Contador de caracteres
        const descField = document.getElementById('descripcion');
        if(descField) {
            descField.addEventListener('input', () => {
                const count = descField.value.length;
                document.getElementById('char-count').innerText = `${count}/150`;
                document.getElementById('char-count').className = count >= 140 ? "text-[10px] font-bold text-red-500" : "text-[10px] font-bold text-blue-600";
                limpiarError('descripcion');
            });
        }

        // Validaci√≥n de inputs
        function limpiarError(campo) {
            const input = document.getElementById(campo);
            const error = document.getElementById(`error-${campo}`);
            if(input) input.classList.remove('input-error');
            if(error) error.classList.add('hidden');
        }

        function mostrarError(campo, mensaje) {
            const input = document.getElementById(campo);
            const error = document.getElementById(`error-${campo}`);
            if(input) input.classList.add('input-error');
            if(error) {
                error.textContent = mensaje;
                error.classList.remove('hidden');
            }
        }

        ['categoria', 'ubicacion_texto', 'descripcion'].forEach(campo => {
            const input = document.getElementById(campo);
            if(input) {
                input.addEventListener('input', () => limpiarError(campo));
                input.addEventListener('change', () => limpiarError(campo));
            }
        });

        // Manejo de foto y GPS
        const fotoInput = document.getElementById('foto');
        if(fotoInput) {
            fotoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(!file) return;

                limpiarError('foto');

                if(file.size > MAX_FILE_SIZE) {
                    mostrarError('foto', 'La imagen no debe superar 5MB');
                    mostrarToast('Imagen muy pesada. M√°ximo 5MB', 'error');
                    this.value = '';
                    return;
                }

                procesarImagen(file);
            });
        }

        function procesarImagen(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64String = e.target.result;
                const base64Data = base64String.split(',')[1];
                document.getElementById('foto_base64').value = base64Data;
                
                document.getElementById('preview-container').innerHTML = `
                    <img src="${base64String}" class="w-full h-32 object-cover rounded-xl mb-2"> 
                    <p class="text-[10px] font-bold text-emerald-500">‚úì IMAGEN LISTA</p>
                    <p class="text-[9px] text-slate-400 mt-1">${(file.size / 1024).toFixed(0)} KB</p>
                `;
                
                console.log('‚úì Imagen convertida a Base64');
            };
            
            reader.readAsDataURL(file);

            EXIF.getData(file, function() {
                let lat = EXIF.getTag(this, "GPSLatitude");
                let lng = EXIF.getTag(this, "GPSLongitude");
                let latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                let lngRef = EXIF.getTag(this, "GPSLongitudeRef") || "W";

                if (lat && lng) {
                    let decLat = convertToDecimal(lat, latRef);
                    let decLng = convertToDecimal(lng, lngRef);
                    
                    document.getElementById('lat').value = decLat;
                    document.getElementById('lng').value = decLng;
                    document.getElementById('gps-status').innerText = "üìç UBICACI√ìN EXACTA DETECTADA";
                    
                    console.log('‚úì GPS:', decLat, decLng);
                    mostrarToast('GPS detectado en la foto', 'success');
                } else {
                    document.getElementById('gps-status').innerText = "‚ö†Ô∏è NO SE DETECT√ì GPS EN LA FOTO";
                }
            });
        }

        function convertToDecimal(coords, ref) {
            let deg = coords[0] + coords[1] / 60 + coords[2] / 3600;
            return (ref === "S" || ref === "W") ? deg * -1 : deg;
        }

        // Cambio de tabs
        function cambiarTab(tab) {
            if(tab === 'nuevo') {
                document.getElementById('tab-nuevo').classList.remove('hidden-tab');
                document.getElementById('tab-historial').classList.add('hidden-tab');
                document.getElementById('btn-nuevo').classList.add('active-btn');
                document.getElementById('btn-historial').classList.remove('active-btn');
            } else {
                document.getElementById('tab-nuevo').classList.add('hidden-tab');
                document.getElementById('tab-historial').classList.remove('hidden-tab');
                document.getElementById('btn-historial').classList.add('active-btn');
                document.getElementById('btn-nuevo').classList.remove('active-btn');
                cargarHistorial();
            }
        }

        // Validar formulario
        function validarFormulario() {
            let esValido = true;

            const categoria = document.getElementById('categoria').value;
            if(!categoria) {
                mostrarError('categoria', 'Selecciona una categor√≠a');
                esValido = false;
            }

            const ubicacion = document.getElementById('ubicacion_texto').value.trim();
            if(!ubicacion || ubicacion.length < 5) {
                mostrarError('ubicacion_texto', 'Indica la ubicaci√≥n (m√≠n. 5 caracteres)');
                esValido = false;
            }

            const descripcion = document.getElementById('descripcion').value.trim();
            if(!descripcion || descripcion.length < 10) {
                mostrarError('descripcion', 'Describe el problema (m√≠n. 10 caracteres)');
                esValido = false;
            }

            if(!esValido) {
                mostrarToast('Completa todos los campos requeridos', 'warning');
            }

            return esValido;
        }

        // Enviar reporte
        async function enviarReporte() {
            if(!validarFormulario()) return;

            const btn = document.getElementById('btn-enviar');
            const btnText = document.getElementById('btn-text');
            
            btn.disabled = true;
            btnText.innerHTML = '<div class="spinner"></div> ENVIANDO...';

            const session = currentUser || JSON.parse(localStorage.getItem('user_session'));

            // SI NO HAY GPS DE LA FOTO, INTENTAR OBTENER DEL NAVEGADOR
            if(!document.getElementById('lat').value || !document.getElementById('lng').value) {
                logDebug('No GPS in photo, attempting browser location');
                try {
                    await obtenerUbicacionNavegador();
                } catch(e) {
                    logDebug('Browser location failed', e);
                    console.log('‚ÑπÔ∏è No se pudo obtener ubicaci√≥n. Continuando sin coordenadas GPS.');
                }
            }

            const payload = {
                action: 'nuevoReporte',
                usuario: `${session.nombre} ${session.apellido}`,
                email: session.email,
                telefono: session.telefono,
                categoria: document.getElementById('categoria').value,
                ubicacion: document.getElementById('ubicacion_texto').value.trim(),
                descripcion: document.getElementById('descripcion').value.trim(),
                lat: document.getElementById('lat').value || '',
                lng: document.getElementById('lng').value || '',
                foto: document.getElementById('foto_base64').value || ''
            };

            logDebug('Sending report', {
                categoria: payload.categoria,
                hasGPS: !!(payload.lat && payload.lng),
                hasPhoto: !!payload.foto,
                lat: payload.lat,
                lng: payload.lng
            });

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                
                logDebug('Response received', data);
                
                if(data.result === 'success') {
                    mostrarToast(`¬°Reporte enviado! Caso #${data.id}`, 'success');
                    
                    document.getElementById('form-reporte').reset();
                    document.getElementById('foto_base64').value = '';
                    document.getElementById('lat').value = '';
                    document.getElementById('lng').value = '';
                    
                    document.getElementById('preview-container').innerHTML = `
                        <i class="fas fa-camera text-3xl text-blue-900/30 mb-3"></i>
                        <p class="text-xs font-bold text-slate-400">TOMA UNA FOTO O SUBE ARCHIVO</p>
                        <p class="text-[9px] text-blue-500 mt-2 font-black italic uppercase tracking-tighter" id="gps-status"></p>
                    `;
                    document.getElementById('char-count').innerText = '0/150';
                    
                    setTimeout(() => cambiarTab('historial'), 2000);
                }
            } catch (e) { 
                logDebug('Error sending report', e);
                console.error('‚ùå Error:', e);
                mostrarToast('Error al enviar el reporte', 'error');
            } finally { 
                btn.disabled = false; 
                btnText.innerHTML = 'ENVIAR AL MUNICIPIO';
            }
        }

        // Obtener ubicaci√≥n del navegador como respaldo
        async function obtenerUbicacionNavegador() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('Geolocalizaci√≥n no disponible en este navegador');
                    return;
                }
                
                logDebug('Requesting browser location');
                mostrarToast('Obteniendo tu ubicaci√≥n actual...', 'warning');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        
                        document.getElementById('lat').value = lat;
                        document.getElementById('lng').value = lng;
                        
                        const gpsStatus = document.getElementById('gps-status');
                        if(gpsStatus) {
                            gpsStatus.innerText = "üìç UBICACI√ìN ACTUAL OBTENIDA";
                        }
                        
                        mostrarToast('üìç Ubicaci√≥n obtenida del navegador', 'success');
                        logDebug('Browser location obtained', {lat, lng});
                        resolve({lat, lng});
                    },
                    (error) => {
                        logDebug('Browser location error', error.message);
                        
                        let errorMsg = 'No se pudo obtener ubicaci√≥n';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Permiso de ubicaci√≥n denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Ubicaci√≥n no disponible';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Tiempo de espera agotado';
                                break;
                        }
                        
                        console.log('‚ÑπÔ∏è', errorMsg);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Cargar historial
        async function cargarHistorial() {
            const lista = document.getElementById('lista-historial');
            lista.innerHTML = `
                <div class="text-center py-10">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-xs font-bold text-slate-400">BUSCANDO TUS REPORTES...</p>
                </div>
            `;
            
            const session = currentUser || JSON.parse(localStorage.getItem('user_session'));
            
            try {
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'obtenerReportes', email: session.email, rol: 'user' }) 
                });
                const reportes = await res.json();

                if(reportes.length === 0) {
                    lista.innerHTML = '<div class="text-center py-20 opacity-20"><i class="fas fa-folder-open text-5xl mb-4"></i><p class="font-bold text-xs">NO TIENES REPORTES A√öN</p></div>';
                    return;
                }

                lista.innerHTML = reportes.map(r => `
                    <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm report-card">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[9px] bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-black tracking-widest">#${r.id}</span>
                            <span class="text-[9px] px-3 py-1 rounded-full font-black tracking-widest uppercase ${getColor(r.estatus)}">
                                ${r.estatus}
                            </span>
                        </div>
                        <h4 class="text-xs font-black text-blue-900 uppercase mb-1">${r.categoria}</h4>
                        <p class="text-[11px] text-slate-500 mb-3">${r.descripcion}</p>
                        <div class="pt-3 border-t border-slate-50 flex items-center gap-2 text-[9px] text-slate-400 font-bold uppercase italic">
                            <i class="fas fa-map-marker-alt"></i> ${r.ubicacion}
                        </div>
                        ${r.lat && r.lng ? `
                        <div class="mt-2 text-[9px] text-blue-500 font-bold">
                            <i class="fas fa-location-dot"></i> GPS: ${parseFloat(r.lat).toFixed(6)}, ${parseFloat(r.lng).toFixed(6)}
                        </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (e) { 
                console.error('Error:', e);
                lista.innerHTML = '<p class="text-center text-red-500 text-xs font-bold">Error al cargar historial.</p>'; 
            }
        }

        function getColor(s) {
            if(s === 'Pendiente') return 'bg-amber-100 text-amber-600';
            if(s === 'En Proceso') return 'bg-blue-100 text-blue-600';
            return 'bg-emerald-100 text-emerald-600';
        }

        // Logout
        function logout() {
            if(confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
                localStorage.removeItem('user_session');
                currentUser = null;
                mostrarToast('Sesi√≥n cerrada', 'success');
                setTimeout(() => mostrarVista('landing-section'), 1000);
            }
        }
    </script>
</body>
</html>
