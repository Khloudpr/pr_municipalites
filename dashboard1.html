<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aguadilla Command Center | Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .sidebar-link { font-size: 0.85rem; letter-spacing: 0.05em; font-weight: 800; }
        .stat-value { letter-spacing: -2px; }
        body { background: #f1f5f9; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        .btn-logout { transition: all 0.3s ease; }
        .btn-logout:hover { background-color: #dc2626; transform: translateX(5px); }
    </style>
</head>
<body class="font-sans text-slate-900">

    <!-- Mobile Menu Button (solo visible en móvil) -->
    <button onclick="toggleMobileMenu()" class="md:hidden fixed top-4 left-4 z-50 bg-blue-900 text-white p-3 rounded-xl shadow-lg">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="md:hidden fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity"></div>

    <div class="flex min-h-screen">
        <!-- Sidebar Desktop + Mobile -->
        <aside id="sidebar" class="w-72 bg-blue-900 text-white p-8 flex flex-col fixed md:sticky top-0 h-screen shadow-2xl z-40 -translate-x-full md:translate-x-0 transition-transform duration-300">
            <!-- Close button (solo móvil) -->
            <button onclick="toggleMobileMenu()" class="md:hidden absolute top-4 right-4 text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>

            <div class="flex items-center gap-3 mb-12">
                <div class="bg-white text-blue-900 p-1.5 rounded-lg font-black text-xl shadow-lg">AR</div>
                <span class="font-black text-xl uppercase italic tracking-tighter">Aguadilla</span>
            </div>
            <nav class="space-y-6 flex-1">
                <a href="dashboard1.html" class="sidebar-link flex items-center gap-4 bg-blue-800 p-4 rounded-2xl shadow-xl"><i class="fas fa-chart-pie w-6 text-lg"></i> DASHBOARD</a>
                <a href="reportes1.html" class="sidebar-link flex items-center gap-4 opacity-70 hover:opacity-100 transition-all p-2"><i class="fas fa-clipboard-list w-6 text-lg"></i> REPORTES</a>
                <a href="mapa1.html" class="sidebar-link flex items-center gap-4 opacity-70 hover:opacity-100 transition-all p-2"><i class="fas fa-map-marked-alt w-6 text-lg"></i> MAPA</a>
            </nav>
            
            <!-- User Info & Logout Section -->
            <div class="border-t border-blue-800 pt-6 space-y-4">
                <div class="bg-blue-800/50 rounded-2xl p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="bg-blue-700 w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-black text-white truncate" id="user-name">Empleado</p>
                            <p class="text-[9px] text-blue-300 truncate" id="user-email">email@aguadilla.com</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="cerrarSesion()" class="btn-logout w-full bg-red-600 hover:bg-red-700 text-white p-3 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-black text-sm uppercase tracking-wider">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </button>
            </div>
            
            <div class="pt-4 text-[10px] font-black text-blue-400 uppercase tracking-widest italic text-center">
                GovTech Solutions v4.0
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-10 w-full">
            <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h1 class="text-3xl md:text-5xl font-black text-slate-800 tracking-tighter italic uppercase leading-none">Intelligence Hub</h1>
                    <p class="text-blue-600 font-black text-xs mt-2 uppercase tracking-[0.3em]">Gestión de Infraestructura Crítica</p>
                </div>
                <div class="flex gap-3">
                    <div class="bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-200 flex items-center gap-3">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span>
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest" id="last-sync">Live Data</span>
                    </div>
                    <button onclick="fetchDashboardData()" class="bg-blue-900 text-white p-3 rounded-2xl shadow-lg hover:bg-blue-800 transition-all">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="glass-card p-6 rounded-[2.5rem] shadow-sm">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Reportes</p>
                    <div class="flex items-end gap-2">
                        <h2 id="kpi-total" class="text-5xl font-black text-slate-800 stat-value">0</h2>
                        <span class="text-green-500 font-bold text-xs mb-2">+12%</span>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] shadow-sm border-b-4 border-green-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Eficiencia de Resolución</p>
                    <div class="flex items-end gap-2">
                        <h2 id="kpi-eficiencia" class="text-5xl font-black text-green-600 stat-value">0%</h2>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] shadow-sm border-b-4 border-blue-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">En Revisión Técnica</p>
                    <div class="flex items-end gap-2">
                        <h2 id="kpi-revision" class="text-5xl font-black text-blue-600 stat-value">0</h2>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem] shadow-sm bg-slate-900">
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Alertas Críticas</p>
                    <div class="flex items-end gap-2">
                        <h2 id="kpi-urgentes" class="text-5xl font-black text-white stat-value">0</h2>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                <div class="lg:col-span-2 bg-white p-8 rounded-[3rem] shadow-xl">
                    <h3 class="font-black text-slate-800 mb-6 italic text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-chart-bar text-blue-900"></i> Incidencias por Categoría
                    </h3>
                    <div class="h-80"><canvas id="chartCategorias"></canvas></div>
                </div>
                <div class="bg-white p-8 rounded-[3rem] shadow-xl flex flex-col">
                    <h3 class="font-black text-slate-800 mb-6 italic text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-adjust text-blue-900"></i> Salud Operativa
                    </h3>
                    <div class="flex-1 flex items-center"><canvas id="chartEstatus"></canvas></div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-8 rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden">
                <h3 class="font-black text-slate-800 mb-6 italic text-xs uppercase tracking-widest">Actividad Reciente en el Municipio</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b">
                                <th class="pb-4">ID Reporte</th>
                                <th class="pb-4">Categoría</th>
                                <th class="pb-4 hidden sm:table-cell">Zona</th>
                                <th class="pb-4">Estatus</th>
                                <th class="pb-4 text-right hidden md:table-cell">Prioridad</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-reciente" class="text-sm font-bold text-slate-600">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgCPHD049p8E6Bns4LcFnPLP1HlDTOCDWHUj7Zt_XYAT0QWxtrUEe0jv75rTxwMKU6/exec";
        let chartEstatus, chartCategorias;

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('opacity-0', 'pointer-events-none');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('opacity-0', 'pointer-events-none');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
            }
        }

        // Verificar sesión al cargar
        window.onload = function() {
            verificarSesion();
            fetchDashboardData();
        };

        function verificarSesion() {
            const session = JSON.parse(localStorage.getItem('user_session') || 'null');
            
            if (!session || !session.email) {
                window.location.href = 'index.html';
                return;
            }

            if (session.rol !== 'empleado' && session.rol !== 'admin') {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('user-name').textContent = `${session.nombre} ${session.apellido}`;
            document.getElementById('user-email').textContent = session.email;
        }

        function cerrarSesion() {
            if (confirm('¿Estás seguro que deseas cerrar sesión?')) {
                localStorage.removeItem('user_session');
                window.location.href = 'index.html';
            }
        }

        async function fetchDashboardData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                processData(data);
            } catch (e) { console.error(e); }
        }

        function processData(reportes) {
            const total = reportes.length;
            const resueltos = reportes.filter(r => r.estatus === 'Completado').length;
            const eficiencia = total > 0 ? Math.round((resueltos / total) * 100) : 0;
            const revision = reportes.filter(r => r.estatus === 'En Revisión').length;
            const urgentes = reportes.filter(r => r.prioridad === 'Alta').length;

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-eficiencia').innerText = eficiencia + "%";
            document.getElementById('kpi-revision').innerText = revision;
            document.getElementById('kpi-urgentes').innerText = urgentes;

            const catCounts = {};
            reportes.forEach(r => {
                const cat = r.categoría || r.categoria || 'Sin categoría';
                catCounts[cat] = (catCounts[cat] || 0) + 1;
            });
            updateBarChart(catCounts);

            const statusCounts = {
                'Nuevo': reportes.filter(r => r.estatus === 'Nuevo').length,
                'Pendiente': reportes.filter(r => r.estatus === 'Pendiente').length,
                'Completado': reportes.filter(r => r.estatus === 'Completado').length
            };
            updateDoughnutChart(statusCounts);

            const ultimosCinco = reportes.slice(-5).reverse();
            document.getElementById('tabla-reciente').innerHTML = ultimosCinco.map(r => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-all">
                    <td class="py-4 text-blue-900 font-black italic uppercase text-xs md:text-base">AG-${r.id_reporte}</td>
                    <td class="py-4 text-xs md:text-base">${r.categoría || r.categoria || 'Sin categoría'}</td>
                    <td class="py-4 text-slate-400 font-medium italic hidden sm:table-cell text-xs md:text-base">${r.ubicación || r.ubicacion || 'Sin ubicación'}</td>
                    <td class="py-4 text-[10px] font-black uppercase text-slate-400">${r.estatus}</td>
                    <td class="py-4 text-right hidden md:table-cell">
                        <span class="px-3 py-1 rounded-full text-[9px] ${r.prioridad === 'Alta' ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'}">
                            ${r.prioridad || 'Media'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateBarChart(counts) {
            const ctx = document.getElementById('chartCategorias');
            if(chartCategorias) chartCategorias.destroy();
            chartCategorias = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: '#1e3a8a',
                        borderRadius: 15,
                        barThickness: 30
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateDoughnutChart(counts) {
            const ctx = document.getElementById('chartEstatus');
            if(chartEstatus) chartEstatus.destroy();
            chartEstatus = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#ef4444', '#f97316', '#22c55e'],
                        borderWidth: 10,
                        borderColor: '#ffffff'
                    }]
                },
                options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold', size: 10 } } } } }
            });
        }
    </script>
</body>
</html>
